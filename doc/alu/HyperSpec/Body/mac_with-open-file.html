<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!-- Common Lisp HyperSpec (TM), version 3.0 generated by kmp on Thu, 2-May-1996 10:21am EDT -->
<HTML>
<HEAD>
<TITLE>CLHS: macro WITH-OPEN-FILE</TITLE>
<META HTTP-EQUIV="Author" CONTENT="Kent M. Pitman">
<META HTTP-EQUIV="Organization" CONTENT="The Harlequin Group Limited">
<LINK REL=TOP HREF="../FrontMatter/index.html">
<LINK REL=COPYRIGHT HREF="../FrontMatter/About-HyperSpec.html#Legal">
<LINK REL=DISCLAIMER HREF="../FrontMatter/About-HyperSpec.html#Disclaimer">
<LINK REL=PREV HREF="fun_stream-external-format.html">
<LINK REL=UP HREF="sec_the_streams_dictionary.html">
<LINK REL=NEXT HREF="fun_close.html">
</HEAD>
<BODY BGCOLOR="#c0c0c0">
<H1><A REV=MADE HREF="http://www.harlequin.com/"><IMG ALT="[HARLEQUIN]" SRC="../Graphics/Harlequin-Small.gif" ALIGN=Bottom></A><A REL=TOP HREF="../FrontMatter/index.html"><IMG ALT="[Common Lisp HyperSpec (TM)]" SRC="../Graphics/HyperSpec-Small.gif" ALIGN=Bottom></A> <A REL=PREV HREF="fun_stream-external-format.html"><IMG ALT="[Previous]" SRC="../Graphics/Prev.gif" ALIGN=Bottom></A><A REL=UP HREF="sec_the_streams_dictionary.html"><IMG ALT="[Up]" SRC="../Graphics/Up.gif" ALIGN=Bottom></A><A REL=NEXT HREF="fun_close.html"><IMG ALT="[Next]" SRC="../Graphics/Next.gif" ALIGN=Bottom></A></H1>

<HR>

<A NAME="with-open-file"><I>macro</I> <B>WITH-OPEN-FILE</B></A> <P>
 <P>
<P><B>Syntax:</B><P>
 <P>

<B>with-open-file</B> <I>(stream filespec <I>options</I><B>*</B>) <I>declaration</I><B>*</B> <I>form</I><B>*</B></I><P> =&gt; <I>results</I><P>
 <P>
<P><B>Arguments and Values:</B><P>
 <P>
<I>stream</I> -- a variable. <P>
 <I>filespec</I>---a <A REL=DEFINITION HREF="glo_p.html#pathname_designator"><I>pathname designator</I></A>.  <P>
<I>options</I> -- <A REL=DEFINITION HREF="glo_f.html#form"><I>forms</I></A>; evaluated. <P>
<I>declaration</I>---a <A REL=DEFINITION HREF="sym_declare.html#declare"><B>declare</B></A> <A REL=DEFINITION HREF="glo_e.html#expression"><I>expression</I></A>; not evaluated. <P>
<I>forms</I>---an <A REL=DEFINITION HREF="glo_i.html#implicit_progn"><I>implicit progn</I></A>. <P>
<I>results</I>---the <A REL=DEFINITION HREF="glo_v.html#value"><I>values</I></A> returned by the <I>forms</I>. <P>
<P><B>Description:</B><P>
 <P>
 <A REL=DEFINITION HREF="#with-open-file"><B>with-open-file</B></A> uses <A REL=DEFINITION HREF="fun_open.html#open"><B>open</B></A> to create a <A REL=DEFINITION HREF="glo_f.html#file_stream"><I>file stream</I></A>  to <A REL=DEFINITION HREF="glo_f.html#file"><I>file</I></A> named by <I>filespec</I>. <I>Filespec</I> is the name of the file to be opened. <I>Options</I> are used as keyword arguments to <A REL=DEFINITION HREF="fun_open.html#open"><B>open</B></A>. <P>
 The <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A> <A REL=DEFINITION HREF="glo_o.html#object"><I>object</I></A> to which the <I>stream</I> <A REL=DEFINITION HREF="glo_v.html#variable"><I>variable</I></A> is <A REL=DEFINITION HREF="glo_b.html#bound"><I>bound</I></A> has <A REL=DEFINITION HREF="glo_d.html#dynamic_extent"><I>dynamic extent</I></A>; its <A REL=DEFINITION HREF="glo_e.html#extent"><I>extent</I></A> ends when the <A REL=DEFINITION HREF="glo_f.html#form"><I>form</I></A> is exited.  <P>
<A REL=DEFINITION HREF="#with-open-file"><B>with-open-file</B></A> evaluates the <I>forms</I> as an <A REL=DEFINITION HREF="glo_i.html#implicit_progn"><I>implicit progn</I></A> with <I>stream</I> bound to  the value returned by <A REL=DEFINITION HREF="fun_open.html#open"><B>open</B></A>.  <P>
When control leaves the body, either normally or abnormally (such as by use of <A REL=DEFINITION HREF="speope_throw.html#throw"><B>throw</B></A>), the file is automatically closed. If a new output file is being written, and control leaves abnormally, the file is aborted and the file system is left, so far as possible, as if the file had never been opened. <P>
It is possible by the use of <TT>:if-exists nil</TT> or <TT>:if-does-not-exist nil</TT> for <I>stream</I> to be bound to <A REL=DEFINITION HREF="any_nil.html#nil"><B>nil</B></A>.  Users of <TT>:if-does-not-exist nil</TT> should check for a valid <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A>.  <P>
 The consequences are undefined if an attempt is made to <A REL=DEFINITION HREF="glo_a.html#assign"><I>assign</I></A> the <I>stream</I> <A REL=DEFINITION HREF="glo_v.html#variable"><I>variable</I></A>. The compiler may choose to issue a warning if such an attempt is detected.  <P>
<P><B>Examples:</B><P>
 <P>
<PRE>
 (setq p (merge-pathnames &quot;test&quot;))
=&gt;  #&lt;PATHNAME :HOST NIL :DEVICE device-name :DIRECTORY directory-name
    :NAME &quot;test&quot; :TYPE NIL :VERSION :NEWEST&gt;
 (with-open-file (s p :direction :output :if-exists :supersede)
    (format s &quot;Here are a couple~%of test data lines~%&quot;)) =&gt;  NIL
 (with-open-file (s p)
    (do ((l (read-line s) (read-line s nil 'eof)))
        ((eq l 'eof) &quot;Reached end of file.&quot;)
     (format t &quot;~&amp;*** ~A~%&quot; l)))
&gt;&gt;  *** Here are a couple
&gt;&gt;  *** of test data lines
=&gt;  &quot;Reached end of file.&quot;
</PRE>
</TT> <P>
 
<PRE>
;; Normally one would not do this intentionally because it is
;; not perspicuous, but beware when using :IF-DOES-NOT-EXIST NIL
;; that this doesn't happen to you accidentally...
 (with-open-file (foo &quot;no-such-file&quot; :if-does-not-exist nil)
   (read foo))
&gt;&gt;  hello?
=&gt;  HELLO? ;This value was read from the terminal, not a file!

;; Here's another bug to avoid...
 (with-open-file (foo &quot;no-such-file&quot; :direction :output :if-does-not-exist nil)
   (format foo &quot;Hello&quot;))
=&gt;  &quot;Hello&quot; ;FORMAT got an argument of NIL!
</PRE>
</TT>  <P>
<P><B>Side Effects:</B><P>
 <P>
Creates a <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A> to the <A REL=DEFINITION HREF="glo_f.html#file"><I>file</I></A> named by <I>filename</I> (upon entry), and closes the <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A> (upon exit). In some <A REL=DEFINITION HREF="glo_i.html#implementation"><I>implementations</I></A>, the <A REL=DEFINITION HREF="glo_f.html#file"><I>file</I></A> might be locked in some way while it is open. If the <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A> is an <A REL=DEFINITION HREF="glo_o.html#output"><I>output</I></A> <A REL=DEFINITION HREF="glo_s.html#stream"><I>stream</I></A>, a <A REL=DEFINITION HREF="glo_f.html#file"><I>file</I></A> might be created. <P>
<P><B>Affected By:</B><P>
 <P>
The host computer's file system. <P>
<P><B>Exceptional Situations:</B><P>
 <P>
 See the <A REL=DEFINITION HREF="glo_f.html#function"><I>function</I></A> <A REL=DEFINITION HREF="fun_open.html#open"><B>open</B></A>.  <P>
<P><B>See Also:</B><P>
 <P>
 <A REL=DEFINITION HREF="fun_open.html#open"><B>open</B></A>, <A REL=DEFINITION HREF="fun_close.html#close"><B>close</B></A>, <A REL=DEFINITION HREF="syscla_pathname.html#pathname"><B>pathname</B></A>, <A REL=DEFINITION HREF="syscla_logical-pathname.html#logical-pathname"><B>logical-pathname</B></A>,   <A REL=CHILD HREF="sec_19-1-2.html">Section 19.1.2 (Pathnames as Filenames)</A>  <P>
<P><B>Notes:</B> None.
 <P>
  <P>
 <P>
<P><HR>The following <A REL=META HREF="../FrontMatter/X3J13-Issues.html">X3J13 cleanup issues</A>, <I>not part of the specification</I>, apply to this section:<P><UL><LI> <A REL=CHILD HREF="../Issues/iss258.html">PATHNAME-HOST-PARSING:RECOGNIZE-LOGICAL-HOST-NAMES</A><LI> <A REL=CHILD HREF="../Issues/iss259.html">PATHNAME-LOGICAL:ADD</A><LI> <A REL=CHILD HREF="../Issues/iss157.html">FILE-OPEN-ERROR:SIGNAL-FILE-ERROR</A><LI> <A REL=CHILD HREF="../Issues/iss363.html">WITH-OPEN-FILE-SETQ:EXPLICITLY-VAGUE</A><LI> <A REL=CHILD HREF="../Issues/iss362.html">WITH-OPEN-FILE-DOES-NOT-EXIST:STREAM-IS-NIL</A><LI> <A REL=CHILD HREF="../Issues/iss364.html">WITH-OPEN-FILE-STREAM-EXTENT:DYNAMIC-EXTENT</A><LI> <A REL=CHILD HREF="../Issues/iss327.html">STREAM-ACCESS:ADD-TYPES-ACCESSORS</A><LI> <A REL=CHILD HREF="../Issues/iss097.html">DECLS-AND-DOC</A><P></UL>
<HR>

<A REL=NAVIGATOR HREF="../FrontMatter/Starting-Points.html"><IMG ALT="[Starting Points]" SRC="../Graphics/Starting-Points.gif" ALIGN=Bottom></A><A REL=TOC HREF="../FrontMatter/Chapter-Index.html"><IMG ALT="[Contents]" SRC="../Graphics/Contents.gif" ALIGN=Bottom></A><A REL=INDEX HREF="../FrontMatter/Master-Index.html"><IMG ALT="[Index]" SRC="../Graphics/Index.gif" ALIGN=Bottom></A><A REL=INDEX HREF="../FrontMatter/Symbol-Index.html"><IMG ALT="[Symbols]" SRC="../Graphics/Symbols.gif" ALIGN=Bottom></A><A REL=GLOSSARY HREF="../Body/sec_26-1.html"><IMG ALT="[Glossary]" SRC="../Graphics/Glossary.gif" ALIGN=Bottom></A><A HREF="../Issues/Issues-Categorized.html"><IMG ALT="[Issues]" SRC="../Graphics/Issues.gif" ALIGN=Bottom></A><BR>

<A REL=COPYRIGHT HREF="../FrontMatter/About-HyperSpec.html#Legal"><I>Copyright 1996, The Harlequin Group Limited.  All Rights Reserved.</I></A><P>
</BODY>
</HTML>
